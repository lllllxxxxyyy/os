# 6.1空间的协调—外存储器

## 一.外存的特点

外存和内存的区别？

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230421190121135.png" alt="image-20230421190121135" style="zoom:80%;" />

外存——**最本质特征**就是**无法通过访存指令直接访问**，其他的特征都是辅助特征，，一个存储器是否是外存，不取决于存储器的物理属性，而是它在计算机架构中的访问属性

外存一般是只能**按块访问**、**不能高效随机访问的**。这是因为它们往往需要将容量做得很大，为缩减成本，在研发时就牺牲了其随机访问的能力。同时，很多资料需要永久保存，因此外存往往还是非易失的。这进一步牺牲了外存的访问速度和延迟， 使其性能全面落后于内存。

外存的特点：

1. 可靠性

   相较内存而言，外存需要跨上电周期**长时间储存数据**，因此其可靠性更加重要。很多外存技术为了容量极大地牺牲了原生物理存储单元的可靠性，因此需要**软件纠错措施**加以补强。

2. 保持时间

   外存能够在机器掉电后保持内容不变，但这种能力并非无限的。对于那些储存电荷的外存，一旦失去电力，其**数据便开始退化**，**在一段时间后便无法读写**。其它原理的外存往往也会由于介质的**逐渐劣化而影响数据的完整性**。

   准确地讲，在随时间劣化的是可靠性，保持时间仅仅是可靠性劣化速度的一个体现。当存储单元的可靠性恶化到无法靠软件纠错来补救，保持时间也就到头了。

    保持时间和可靠性在实践中受非常多因素影响，包括访问的累计次数、环境温度、介质工作模式等等。

3. 可擦写性

   部分外存介质如只读光盘等是不能够反复擦写的。它们只能接受一次写入，而后其内容便不可更改。当然，也存在可以反复擦写的光盘。常见的外存如硬盘等都是可以反复擦写的

4. 可覆写性

   部分外存介质可以反复擦写，但是却**无法直接在已经写有内容的介质上直接覆盖写入新内容**。要复用已经写入过的介质，必须要执行**擦除**操作，该操作会清空一整片介质上的旧内容，然后这片介质才能接受新的写入。

5. 访问粒度

   **外存的读（Read）、写（Write/Program）和擦除（Erase）粒度是相互独立的三个参数**，它们都可以是字节或（大小不等的）块。比如，完全可能存在某种外存介质，它可以接受以字节读取，但必须按块写入，而擦除时则只接受全盘擦除。

6. 访问寿命（耐久性）

   **外存的读、写和擦除寿命也是相互独立的三个参数。**它们都标志着对其存储单元进行多少次相应操作后存储单元即告报废。绝大多数外存介质的读寿命都是无限长的，但其写寿命和擦除**（耐久性）** 寿命则是有限的。一次写入/擦除操作称为一个循环，又称一次 P/E。我们经常用P/E数来衡量外存介质的寿命。

7. 访问延迟

   因外存介质的物理组织较为复杂，其**不同地址存储单元的访问延迟差别很大**，且该延迟与访问顺序可能存在很大关系。此外，读、写和擦除的延迟可以不同，而且差距还可以很大。

外存的内存化

随着技术发展，外存技术逐渐摆脱了不能随机访问、无法覆写、 耐久性差的传统印象。以FRAM和PCRAM为代表的外存技术逐渐可以在各项性能上与内存相媲美，同时拥有近乎无限的P/E数。 因此，这些技术逐渐衍生出可以直接插入内存插槽的形式，并可以当作系统内存使用。

内存的外存化

在DRAM上加上后备电池或者闪存，它就可以持久保存内容，此时称为NV（Non-Volatile）DRAM；再将它挂载到外存总线上，它就可以充当快速的外存。在SSD出现以前，这是非常常用的实现高速外存的手段。直到今天，这种手段仍在数据中心和加速器等场合有用武之地。



## 二.数据和文件系统

### 2.1文件的概念

分类：

1. 文本文件——由字符组成的文件，可以用文本编辑器打开
2. 二进制文件——由无约束二进制字节流组成的文件，用文本编辑器打开会乱码

定义：

文件——一个具备一些**属性**的数据记录。我们可以根据其属性对相对应的数据记录进行**增（Create）删（Delete）改（Update）查 （Read；合称CRUD）**。它一般需要被**永久保存**，因而存储在非易失性**外存**上；可以看作是对外存的一种组织和抽象。

属性——文件的属性一般至少包括**文件名**，有时还包括**文件大小、 创建日期、修改日期、文件权限、所有者**等内容。除文件名外，它们一般都被储存在**文件控制块（File Control Block，FCB）**中

逻辑结构：

1. 字节流结构——最基本的结构，提供一个连续的存储空间，可以放置数据
2. 记录结构——提供一个固定大小的存储空间，可以放置大小固定的数据块
3. 索引结构——提供键值对，键—>值

物理结构——文件在外存上的物理保存形式，由多个中间映射层负责决定。

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230421193117974.png" alt="image-20230421193117974" style="zoom:80%;" />



### 2.2	文件系统的概念

定义：

文件系统：

将文件中的**文件块**按照一定的方法最终**映射**到物理设备上的**物理块**，并在物理存储器特性的限制下**提供尽可能高的信息管理效率**。提供这种功能的**软件栈**称为文件系统。一般地，它**提供按名称和路径访问文件的功能。**

 广义的文件系统包括这个映射中的所有层次。狭义的文件系统仅仅指从文件映射到逻辑设备这一个层次。



能不能将文件系统看成数据库？？

不能，文件系统更底层，更原始，提供的功能少，侧重数据的存储而不是查询，键值存储

关系型数据库则在文件系统的基础上提供更多数据抽象、数据查询、数据去重、数据统计、并发控制、 故障恢复、权限控制等功能，可以看做是文件系统的升级版。



**逻辑设备**——**逻辑上**存在的**外存设备**。它可能是一个或数个物理外存设备按照某种方法拆分或组合产生的设备，内部的块称为逻辑块 （Logical Block）

区分——物理存储器按块号**分成**多个连续的逻辑存储器

阵列——将物理存储器按照一定规则**整合**到一个逻辑存储器

**物理设备**——实际存在的存储硬件设备

**物理介质**——物理设备中包含的实际存储介质



**块的映射**

早期：外存和内存**区别不大**，接入系统中的存储器**是磁芯存储器和磁泡存储器**，它同时具备**非易失性和随机访问的能力**；其它存储器包括打孔卡片、纸带等需要人工装入计算机，它们可以看作是最早的外存。此时，访问任何一个文件块地址就是访问存储介质的物理块地址，因为**一个物理存储介质上只存储一个文件**。

容量的增大：随着磁盘容量的进一步增大，**制造完美无瑕的存储介质变得不可能**。一片物理磁盘中，总有几个地方是有缺陷的，无法存储数据，这些缺陷称为**坏块**。然而，**存储设备必须给操作系统呈现连续而完美的设备存储空间**，因此要引入地址重映射的办法将这些**坏块屏蔽**掉。

在现代SSD中，**从设备块到物理块的翻译**由**闪存翻译层**（Flash  Translation Layer，FTL）负责，它兼具**坏块屏蔽、磨损均衡和存储空间整理**等作用。

灵活性的提升：

随着硬盘容量的进一步增加，对硬盘管理的灵活性也在提升。 有时，我们希望**将硬盘分成多个区域**，每个区域负责一种或一 类用途，每个区域可以单独备份、迁移和管理；另一些时候， 我们希望**将多块硬盘组合成一个大的存储池**，用来承载单块硬盘难以承载的数据量，或者提高存储的可靠性。

 此时便出现了逻辑设备的概念：它和物理设备之间可以是**一对 一、一对多、多对一或多对多**。在现代云计算中，存储层次更复杂，对存储灵活性的要求更高，甚至要求存储器的热插拔和程序的热迁移，因此逻辑设备与物理设备之间的映射越发复杂

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230421201024217.png" alt="image-20230421201024217" style="zoom:67%;" />

**路径和目录**

文件系统一般以**树状**的方式组织文件

路径——文件在文件系统中的位置用**路径**表示。路径字符串由**一系列由分隔符隔开的子字符串组成**，它唯一确定一个文件。路径又可 以分为绝对路径和相对路径。分隔符一般是“/”或者“\”

目录——文件路径中由分隔符隔开的子字符串，又称文件夹。每一个目录都对应于一个文件组织层次。目录可以互相嵌套，一个目录下的其它目录称为它的子目录。

相对路径——从**某个目录D起始**，经由逐步查找能找到某文件F的路径，称为F相对于D的路径

绝对路径——某文件F相对于**系统根目录**的路径。也即从系统根目录出发，一步步跟随查找，能找到该文件F。

工作目录——某**应用程序**进行文件路径解析的**起始目录**。该程序中的一切路径都看做是对该目录的相对路径。

 	

特殊目录——为了让**姐妹关系的目录**也能**使用相对路径进行互相引用**，每个目录下都设置两个子目录，它们是文件系统自动创建的。

- **目录“ . ”** **当前目录**。这在一些需要指定某路径为当前目录的场合特别有用，比如指定程序的工作目录为当前目录就可以写“./”。
- **目录“ .. ”** 当前目录的**父目录**。引用这个目录就等于回到 当前目录的父目录。



### 2.3文件系统的组织

文件系统的性能指标：（只考虑文件系统—物理介质两个层次）

| **性能指标**   | **评价方式**                     |
| -------------- | -------------------------------- |
| 连续读取       | MB/s，带宽                       |
| 随机读取       | IO/s，操作数量，或者ms，响应延迟 |
| 连续写入       | MB/s，带宽                       |
| 随机写入       | IO/s，操作数量，或者ms，响应延迟 |
| 覆盖修改       | MB/s，带宽                       |
| 增加修改       | MB/s，带宽                       |
| 按名称查询文件 | ms，响应延迟                     |
| 按内容查询文件 | ms，响应延迟                     |
| 文件内寻址     | ms，响应延迟                     |
| 存储使用率     | %，百分比                        |
| 故障容错性     | N/A                              |

文件的存储：

**1. 连续分配法**

定义：将文件一个接一个的放置在外存上**，每个文件占据连续的物理介质块**

FCB只记录文件的起始块号和长度，就能唯一确定一个文件

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230421203454149.png" alt="image-20230421203454149" style="zoom:50%;" />

优点：顺序和随机读写速度都快，不会出现内部碎片，管理数据结构短小精悍，存储介质利用率高，存储介质损坏只影响部分数据，数据可靠性高。

缺点：文件长度难以随意追加，可能存在外部碎片

适用场合：数据备份和归档等倾向于单次写多次读（Write Once Read Many， WORM）的场合。典型例子是用于LTO磁带的线性磁带文件系统 （Linear Tape File System，LTFS）

**2. 链接分配法**

定义：按照某个固定的块大小分配文件，每个块内部放置一个指针，指向下一个块。如果没有后续块，使用空指针。

FCB中只要记录文件的起始块号就能顺藤摸瓜找到整个文件；也可以说每个文件对应了一条块链。

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230421204833617.png" alt="image-20230421204833617" style="zoom:50%;" />

优点：文件长度可以随意增加，不会产生外部碎片

缺点：顺序读写慢，随机读写更慢，管理数据结构包含指针，指针本身消耗存储介质，存储介质破坏，会导致指针丢失，所以数据的可靠性差。

问题：	分配块的大小的选择？



**3. 链接分配法的改进**

连续分配和链式分配的折中。

利用链表来避免外部碎片，利用可变长度块来避免内部碎片，

可变长度块称为**扩展**，内部包含指向下一个扩展的指针以及本扩展的长度，

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230421213117775.png" alt="image-20230421213117775" style="zoom:50%;" />

优点：文件长度可以随意增减，不会产生外部碎片，同时扩展的大小灵活，也不会产生内部碎片。

缺点：顺序读写有一定提升，随机读写还是慢，管理数据结构包含指针和扩展长度，在存储碎片化严重时候可能进一步消耗存储介质，存储介质破坏，会导致指针丢失，所以数据的可靠性差。

应用场景：这种文件系统是实用的最简单文件系统，其典型代表为exFAT。 exFAT支持按照固定块进行链表分配，也支持将整个文件放在一 个扩展中。但它不允许将整个文件分成两个或更多扩展。

**4. 链接分配法的继续改进**

链表备份——不将指针和扩展长度和文件结构存储在一起，而是分开，给他们单独的存储空间

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230421213606982.png" alt="image-20230421213606982" style="zoom:50%;" />

优点：管理结构就和数据分开，只需要单独备份管理信息就可以，管理结构中包含所有文件的所有块的组织信息，而且本身短小精悍，可以在盘上保存多个备份，只要还有一份管理信息在，整个文件系统就没有受结构性破坏，抗损性强，数据区受损只会引起数据损坏，不会导致文件系统崩溃。

随机访问提速 ：小巧的管理结构可以被单独加载进内存。这样，随机寻址虽然 还是要做指针追逐，但是在内存中追逐指针速度要快得多。

**5.索引分配法**

索引分配——给每个文件创建一个线性索引表，每个表项记载对应于该逻辑块的物理块

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230421214842136.png" alt="image-20230421214842136" style="zoom:50%;" />

优点：连续和随机访问都快，抗损性能也强，、

确定：索引预留多了，浪费，索引预留少了，文件大小受限

**6.索引分配的改进**

**多级索引**——像组织页表，将多个索引表以层次的形式组织起来，每个层次负责翻译逻辑块号的一部分，最终得到物理块号，不使用的索引就不创建，不填充，虽然随机访问仍然引起指针追逐， 但是追逐的次数是有限的，也即索引的层数。

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230421220022775.png" alt="image-20230421220022775" style="zoom:50%;" />

解决给文件预留多少索引的问题

稀疏文件——有一些文件仅占用整个逻辑空间中的几个很分散的逻辑块，而其 它块都是0。索引分配法可以轻松应对这种情况：不为那些全0的 逻辑块填充索引，也不为它们分配空间即可。

应用场景—— 除exFAT这种需要和极其古老的链式分配的FAT兼容的文件系统之外， 绝大多数现代文件系统都采取多级索引分配法。



**7.索引分配法的继续改进**

**混合索引**——文件的索引采取多级方法进行，但索引的级数随着文件块号的增加而增加。文件越靠前的部分，索引的级别越少。这样，小文件的存储效率就提高了

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230421220036191.png" alt="image-20230421220036191" style="zoom:50%;" />



**8.混合索引法的继续改进**

直接内容法——文件非常小的时候，允许将文件内容直接记录再FCB中

从连续存储法的视角出发，这可以看作是连续存储法的一种应用；从索引存储 法的视角出发，这可以看作是“零级索引”，它们的内容直接就是文件内容。

<img src="C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20230423161422028.png" alt="image-20230423161422028" style="zoom:50%;" />



**空闲块**——文件系统中暂时未被占用的物理块

怎么处理空闲块？

连续存储——将所有空闲块的地址和长度存储在表格中

链表存储——将所有空闲块放在链表中

索引存储——将所有空闲块放到多级索引中

| **存储方式** | **优点**                                                     | **缺点**                                                     |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 连续存储     | 简单好实现，空闲块及其范围一目了然。分配和释放可以照内存分配的办法操作。 | 空闲块列表需要额外的空间来存储，而且该列表的大小是固定的，必须能够放下所有的物理块。 |
| 链表存储     | 相对而言也比较简单，分配单个块很容易。                       | 分配和释放大量块时候会导致大量磁盘读写；找连续的扩展很麻烦。 |
| 索引存储     | 在分配单个块较容易的基础上，分配和释放大量块比较高效，因为索引表可以一次填充很多。 | 分配单个块需要做多级指针追逐。此外，结构复杂，找连续的扩展时候仍然很麻烦。 |

















## 三.虚拟文件系统